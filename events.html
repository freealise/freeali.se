---
# Feel free to add content and custom Front Matter to this file.
# To modify the layout, see https://jekyllrb.com/docs/themes/#overriding-theme-defaults

layout: default
---

<style type="text/css">
#map-canvas {
  height: 256px;
  margin: 0;
  padding: 0;
}
</style>

<div id="map-canvas"></div>
<div id="text"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDONbj1HFMLs7UI3yBortL4qwLm-0C7mYM"></script>
<script>
  function showResults(a) {
    var url = exec+"?a="+a;
    var xhttp, xmlDoc, txt, x, i, point;
    var bounds = map.getBounds();
    var ne = bounds.getNorthEast();
    var sw = bounds.getSouthWest();
    var maxLat = ne.lat();
    var maxLng = ne.lng();
    var minLat = sw.lat();
    var minLng = sw.lng();
    if (window.XMLHttpRequest) {
        // code for modern browsers
        xhttp = new XMLHttpRequest();
    } else {
        // code for old IE browsers
        xhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
           xmlDoc = xhttp.responseXML;
           txt = "<br>";
           if (a=="events") {
              x = xmlDoc.getElementsByTagName("Placemark");
           } else {
              x = xmlDoc.getElementsByTagName("entry");
           }
           for (i = 0; i < x.length; i++) {
             if (a=="events") {
               point = x[i].getElementsByTagName("coordinates")[0];
             } else {
               point = x[i].getElementsByTagName("georss:point")[0];
             }
             if (point && point.innerHTML) {
               if (a=="events") {
                 var coords = point.innerHTML.split(",");
                 var lat = parseFloat(coords[1]);
                 var lng = parseFloat(coords[0]);
               } else {
                 var coords = point.innerHTML.split(" ");
                 var lat = parseFloat(coords[0]);
                 var lng = parseFloat(coords[1]);
               }
               if (lat>minLat && lat<maxLat && lng>minLng && lng<maxLng) {
                 if (a=="xml") {
                    var html = x[i].getElementsByTagName("summary")[0].innerHTML;
                 } else if (a=="blog") {
                    var html = x[i].getElementsByTagName("content")[0].innerHTML;
                 } else if (a=="events") {
                    var html = x[i].getElementsByTagName("description")[0].innerHTML;
                 }
                 html = html.replace(/&lt;/g, "<");
                 html = html.replace(/&gt;/g, ">");
                 html = html.replace(/&quot;/g, '"');
                 html = html.replace(/&apos;/g, "'");
                 if (a=="events") {
                    txt += "<p><b>" + x[i].getElementsByTagName("name")[0].innerHTML + "</b><br>";
                 } else {
                    txt += "<p><b>" + x[i].getElementsByTagName("title")[0].innerHTML + "</b><br>";
                 }
                 txt += html + "</p>";  
               }
             }
           }
           document.getElementById("text").innerHTML = txt;
           document.getElementsByTagName("section")[0].style.height="auto";
        }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
  }
  
  var exec="https://script.google.com/macros/s/AKfycby9VN3ghF35t1Z4csV9kycvQyBqiYF8irms_ybLMmsZrKFlU9rb/exec";
  //geolocate
  var mapOptions = {
    zoom: 4,
    center: {lat: -34.397, lng: 150.644}
  }
  var d = new Date();
  var t = d.getTime();
  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  var kmlLayer = new google.maps.KmlLayer({
    url: exec+'?a=events&time='+t
  });
  var blogLayer = new google.maps.KmlLayer({
    suppressInfoWindows: true,
    url: 'https://www.freealise.com/feeds/posts/default/?time='+t
  });
  var georssLayer = new google.maps.KmlLayer({
    suppressInfoWindows: true,
    url: exec+'?a=xml&time='+t
  });
  georssLayer.setMap(map);
  
  var listener = google.maps.event.addListener(georssLayer, 'metadata_changed', function() {
    google.maps.event.clearListeners(georssLayer, 'metadata_changed');
    kmlLayer.setMap(map);
    blogLayer.setMap(map);
  });
  
  google.maps.event.addListener(kmlLayer, 'click', function(e) {
    var zoom = map.getZoom();
    if (zoom<12) {
    	map.setZoom(zoom+4);
    }
    map.setCenter(e.latLng);
    var a = "events";
    showResults(a);
  });
  google.maps.event.addListener(blogLayer, 'click', function(e) {
    var zoom = map.getZoom();
    if (zoom<12) {
    	map.setZoom(zoom+4);
    }
    map.setCenter(e.latLng);
    var a = "blog";
    showResults(a);
  });
  google.maps.event.addListener(georssLayer, 'click', function(e) {
    var zoom = map.getZoom();
    if (zoom<12) {
    	map.setZoom(zoom+4);
    }
    map.setCenter(e.latLng);
    var a = "xml";
    showResults(a);
  });
  
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var events = "";
      var values;
      var rows = this.responseText.split("\r\n");
      for (i=0;i<rows.length;i++) {
        if (rows[i]!="") {
            values = rows[i].split(", ");
            events += "<p>" + values[0] + " " + values[1] + " " + values[2] + "</p>";
        }
      }
      document.getElementById("text").innerHTML = events;
      document.getElementsByTagName("section")[0].style.height="auto";
    }
  };
  xhttp.open("GET", "https://script.google.com/macros/s/AKfycby9VN3ghF35t1Z4csV9kycvQyBqiYF8irms_ybLMmsZrKFlU9rb/exec?a=events_csv", true);
  xhttp.send();
</script>
